<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civic Dashboard | CivicBio</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet -->
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Heat -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>


</head>
<body class="bg-light">

<!-- Header -->
<nav class="navbar navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
        <span class="navbar-brand h6 mb-0">CivicBio · Civic Authority</span>
        <a class="btn btn-sm btn-outline-light" href="/auth/logout">Logout</a>
    </div>
</nav>

<div class="container my-3">

    <!-- Summary Cards -->
    <div class="row g-2 my-3">
    <div class="col-6 col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted">Facilities</h6>
                <h4>{{ total_facilities }}</h4>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted">Collectors</h6>
                <h4>{{ total_collectors }}</h4>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted">Waste Today</h6>
                <h4>{{ waste_today_kg }} kg</h4>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted">Disposed Today</h6>
                <h4>{{ disposed_today_kg }} kg</h4>
            </div>
        </div>
    </div>
</div>

<h6 class="mb-2">Pending Approvals</h6>

{% for u in pending_users %}
<div class="card mb-2">
    <div class="card-body">
        <p class="mb-1">
            <strong>{{ u.role|capitalize }}</strong>
        </p>
        <p class="mb-1">
            {{ u.details.get("facility_name") 
               or u.details.get("collector_name")
               or u.details.get("unit_name") }}
        </p>

        <div class="d-flex gap-2 mt-2">
            <button class="btn btn-sm btn-success"
                    onclick="approveUser('{{ u.id }}')">
                Approve
            </button>

            <button class="btn btn-sm btn-danger"
                    onclick="rejectUser('{{ u.id }}')">
                Reject
            </button>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-success">
    ✅ No pending approvals
</div>
{% endfor %}

<h6 class="mt-4 mb-2">Live Waste Overview</h6>

<div class="card mb-2">
    <div class="card-body">
        <p class="mb-1"><strong>Pending:</strong> {{ total_generated }}</p>
        <p class="mb-1"><strong>Collected:</strong> {{ total_collected }}</p>
        <p class="mb-1"><strong>Disposed:</strong> {{ total_disposed }}</p>
    </div>
</div>

<h6 class="mt-4 mb-2">Reported Issues</h6>

{% for issue in issues %}
<div class="card mb-2 border-danger">
    <div class="card-body">
        <p class="mb-1"><strong>Facility:</strong> {{ issue.facility }}</p>
        <p class="mb-1"><strong>Issue:</strong> {{ issue.issue_type }}</p>
        <p class="mb-1">{{ issue.remarks }}</p>
        <span class="badge bg-danger">Open</span>
    </div>
</div>
{% else %}
<div class="alert alert-secondary">
    No reported issues
</div>
{% endfor %}

<h6 class="mt-4 mb-2">Audit Trail</h6>

{% for log in audit_logs %}
<div class="card mb-2">
    <div class="card-body">
        <p class="mb-1">
            <strong>{{ log.action }}</strong>
        </p>
        <p class="mb-1">{{ log.message }}</p>
        <small class="text-muted">
            {{ log.created_at | to_ist | datetime_format('%d %b %Y %I:%M %p') }}
        </small>
    </div>
</div>
{% else %}
<div class="alert alert-secondary">
    No audit records found
</div>
{% endfor %}


    <div class="card mb-3">
        <div class="card-body">
            <h6 class="mb-2">Biomedical Waste Heat Map</h6>
            <small class="text-muted">
                Darker areas indicate higher waste generation
            </small>

            <div id="heatMap"
                style="height:300px;width:100%;border-radius:6px;margin-top:10px;">
            </div>
        </div>
    </div>



</div>

<script>
    // Initialize map (Raipur example)
    const map = L.map('heatMap').setView([21.2514, 81.6296], 12);

    // OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    // Mock biomedical waste hotspot data
    const heatData = [
        [21.2514, 81.6296, 0.9], // Central Hospital
        [21.2350, 81.6500, 0.7], // Diagnostics Lab
        [21.2600, 81.6100, 0.8], // Clinic Zone
        [21.2450, 81.6700, 0.6], // Medical College
        [21.2700, 81.6300, 0.5]  // Peripheral Area
    ];

    // Add heat layer
    L.heatLayer(heatData, {
        radius: 25,
        blur: 18,
        maxZoom: 15
    }).addTo(map);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
function approveUser(uid) {
    fetch(`/civic/api/approve_user/${uid}`, {
        method: "POST"
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        location.reload();
    });
}

function rejectUser(uid) {
    fetch(`/civic/api/reject_user/${uid}`, {
        method: "POST"
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        location.reload();
    });
}
</script>

</body>
</html>
