<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disposal Dashboard | CivicBio</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>
<body class="bg-light">

<!-- Header -->
<nav class="navbar navbar-dark bg-success sticky-top">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h6">CivicBio · Disposal Unit</span>
        <a class="btn btn-sm btn-outline-light" href="/auth/logout">Logout</a>
    </div>
</nav>

<!-- Main Container -->
<div class="container my-3">

    <div class="card m-3">
        <div class="card-body text-center">
            <h6 class="mb-2">Verify Waste Batch</h6>
            <button class="btn btn-success w-100"
                    data-bs-toggle="modal"
                    data-bs-target="#qrScannerModal">
            <i class="fas fa-camera" ></i> Scan Waste QR
            </button>
            <small class="text-muted d-block mt-2">
            Scan QR before disposal
            </small>
        </div>
    </div>

    <div class="card m-3">
    <div class="card-body">
        <p class="mb-1"><strong>Facility:</strong> Apollo Hospital</p>
        <p class="mb-1"><strong>Waste Category:</strong> Yellow</p>
        <p class="mb-1"><strong>Quantity:</strong> 12 kg</p>
        <p class="mb-1"><strong>Collected By:</strong> GreenBio Services</p>

        <div class="alert alert-success mt-3">
        ✅ Waste batch verified
        </div>
    </div>
    </div>


    <div class="card m-3">
    <div class="card-body">
        <h6 class="mb-3">Disposal Method</h6>

        <select class="form-select mb-3">
        <option disabled selected>Select treatment method</option>
        <option>Incineration</option>
        <option>Autoclaving</option>
        <option>Chemical Treatment</option>
        <option>Secure Landfill</option>
        </select>

        <button class="btn btn-success w-100">
        ♻️ Mark as Disposed
        </button>
    </div>
    </div>

    <div class="modal fade" id="qrScannerModal" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">

      <div class="modal-header bg-dark text-white">
        <h6 class="modal-title">Scan Waste QR</h6>
        <button class="btn-close btn-close-white"
                data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-0">
        <video id="video"
               autoplay
               playsinline
               muted
               style="width:100%;height:100%;object-fit:cover;">
        </video>
        <canvas id="canvas" hidden></canvas>
      </div>

      <div class="modal-footer">
        <span id="scanStatus" class="text-muted">
          Align QR inside camera frame
        </span>
      </div>

    </div>
  </div>
</div>


</div>

</body>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<script>
let videoStream;
let scanning = false;

const qrModal = document.getElementById("qrScannerModal");

qrModal.addEventListener("shown.bs.modal", async () => {
  try {
    const video = document.getElementById("video");

    videoStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    video.srcObject = videoStream;
    scanning = true;
    requestAnimationFrame(scanQR);

  } catch (err) {
    alert("Camera error: " + err.message);
  }
});

qrModal.addEventListener("hidden.bs.modal", stopCamera);

function scanQR() {
  if (!scanning) return;

  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const qr = jsQR(img.data, img.width, img.height);

    if (qr) {
      document.getElementById("scanStatus").innerText =
        "✅ Waste Batch Verified";

      alert("QR Data: " + qr.data);
      stopCamera();

      // Optional: auto close modal
      bootstrap.Modal.getInstance(qrModal).hide();
      return;
    }
  }
  requestAnimationFrame(scanQR);
}

function stopCamera() {
  scanning = false;
  if (videoStream) {
    videoStream.getTracks().forEach(t => t.stop());
    videoStream = null;
  }
}
</script>


</html>
